name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:


permissions:
  contents: write

env:
  QT_VERSION: '6.6.0'

jobs:
  # Linux Build - Debian Package (.deb)
  build-linux:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'linux'
        target: 'desktop'

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libgdal-dev \
          libgeos-dev \
          libproj-dev \
          libxcb-cursor0 \
          dpkg-dev \
          fakeroot

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr

    - name: Build
      run: cmake --build build --parallel

    - name: Get Version
      id: version
      run: |
        VERSION="${{ github.ref_name }}"
        VERSION="${VERSION#v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Create Debian Package
      run: |
        PKG_NAME="sitesurveyor"
        PKG_VERSION="${{ steps.version.outputs.version }}"
        PKG_ARCH="amd64"
        PKG_DIR="${PKG_NAME}_${PKG_VERSION}_${PKG_ARCH}"
        
        mkdir -p ${PKG_DIR}/DEBIAN
        mkdir -p ${PKG_DIR}/usr/bin
        mkdir -p ${PKG_DIR}/usr/share/applications
        mkdir -p ${PKG_DIR}/usr/share/icons/hicolor/256x256/apps
        mkdir -p ${PKG_DIR}/usr/share/doc/sitesurveyor
        
        # Copy binary
        cp build/bin/SiteSurveyor ${PKG_DIR}/usr/bin/sitesurveyor
        chmod 755 ${PKG_DIR}/usr/bin/sitesurveyor
        
        # Copy icon
        cp resources/logo/SiteSurveyor.png ${PKG_DIR}/usr/share/icons/hicolor/256x256/apps/sitesurveyor.png
        
        # Create desktop file
        cat > ${PKG_DIR}/usr/share/applications/sitesurveyor.desktop << 'DESKTOP'
[Desktop Entry]
Type=Application
Name=SiteSurveyor
GenericName=Geomatics Software
Comment=Professional Geomatics Software - Developed by Eineva Incorporated
Exec=sitesurveyor
Icon=sitesurveyor
Categories=Science;Engineering;Geography;
Terminal=false
StartupNotify=true
Keywords=survey;geomatics;gis;cad;dxf;cogo;
DESKTOP
        
        # Copy docs
        cp README.md ${PKG_DIR}/usr/share/doc/sitesurveyor/ 2>/dev/null || true
        cp LICENSE ${PKG_DIR}/usr/share/doc/sitesurveyor/copyright 2>/dev/null || true
        
        # Create control file
        cat > ${PKG_DIR}/DEBIAN/control << CTRL
Package: sitesurveyor
Version: ${PKG_VERSION}
Section: science
Priority: optional
Architecture: ${PKG_ARCH}
Depends: libqt6core6, libqt6gui6, libqt6widgets6, libqt6network6, libqt6printsupport6, libgdal30 | libgdal32 | libgdal34, libgeos-c1v5, libproj22 | libproj25, libgl1
Maintainer: Eineva Incorporated <support@eineva.com>
Homepage: https://sitesurveyor.dev
Description: Professional Geomatics Software
 SiteSurveyor is a professional geomatics software for surveying and
 land development. Features include Import/Export (DXF, Shapefile, CSV),
 COGO Calculations, Network Adjustments, and Volumetric Calculations.
 Developed by Eineva Incorporated.
CTRL
        
        # Build the package
        fakeroot dpkg-deb --build ${PKG_DIR}
        
        # Rename to include version tag
        mv ${PKG_DIR}.deb SiteSurveyor-${{ github.ref_name }}-linux-amd64.deb
        
    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-deb
        path: SiteSurveyor-*.deb

  # Windows Build - ZIP with all dependencies
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Qt (MSVC)
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Install Ninja
      run: choco install ninja
      
    - name: Clone vcpkg
      run: git clone https://github.com/microsoft/vcpkg.git
      
    - name: Bootstrap vcpkg
      run: .\vcpkg\bootstrap-vcpkg.bat
      shell: cmd
      
    - name: Restore vcpkg cache
      uses: actions/cache@v4
      with:
        path: |
          vcpkg/installed
          vcpkg/packages
        key: ${{ runner.os }}-vcpkg-release-v4-${{ hashFiles('CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-release-v4-

    - name: Install vcpkg dependencies
      run: .\vcpkg\vcpkg install gdal:x64-windows geos:x64-windows --recurse
      shell: cmd

    - name: Configure CMake
      run: |
        cmake -B build -G "Ninja" `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE="$PWD/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows
      shell: pwsh
        
    - name: Build
      run: cmake --build build --parallel
      
    - name: Create Distribution Folder
      run: |
        # Create dist folder
        New-Item -ItemType Directory -Force -Path dist/SiteSurveyor
        
        # Copy binary
        Copy-Item build/bin/SiteSurveyor.exe dist/SiteSurveyor/
        
        # Run windeployqt to copy Qt dependencies
        & "$env:Qt6_DIR/bin/windeployqt.exe" dist/SiteSurveyor/SiteSurveyor.exe
        
        # Copy GDAL/GEOS DLLs
        Copy-Item vcpkg/installed/x64-windows/bin/*.dll dist/SiteSurveyor/ -ErrorAction SilentlyContinue
        
        # Copy docs
        Copy-Item README.md dist/SiteSurveyor/ -ErrorAction SilentlyContinue
        Copy-Item LICENSE dist/SiteSurveyor/ -ErrorAction SilentlyContinue
        
        # List contents
        Get-ChildItem dist/SiteSurveyor/
      shell: pwsh

    - name: Create ZIP
      run: |
        Compress-Archive -Path dist/SiteSurveyor -DestinationPath SiteSurveyor-${{ github.ref_name }}-windows-x64.zip
      shell: pwsh
      
    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-zip
        path: SiteSurveyor-*.zip

  # Create Release
  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        
    - name: List artifacts
      run: ls -la
      
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: SiteSurveyor ${{ github.ref_name }}
        body: |
          ## SiteSurveyor ${{ github.ref_name }}
          
          **Developed by Eineva Incorporated**
          
          ### Downloads
          
          | Platform | File | Installation |
          |----------|------|--------------|
          | **Windows** | `.zip` | Extract and run `SiteSurveyor.exe` |
          | **Linux (Debian/Ubuntu)** | `.deb` | `sudo dpkg -i *.deb && sudo apt-get install -f` |
          
          ### Windows Installation
          
          1. Download the `.zip` file
          2. Extract to any folder
          3. Run `SiteSurveyor.exe`
          
          ### Linux Installation
          
          ```bash
          sudo dpkg -i SiteSurveyor-${{ github.ref_name }}-linux-amd64.deb
          sudo apt-get install -f  # Install dependencies
          ```
          
          ### Requirements
          - **Windows**: All dependencies included
          - **Linux**: Qt 6, GDAL, GEOS, PROJ (installed via apt)
          - OpenGL 3.3+ support
          - 64-bit operating system
        files: |
          SiteSurveyor-*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
